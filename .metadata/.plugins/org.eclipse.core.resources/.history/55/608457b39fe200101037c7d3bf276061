/* USER CODE BEGIN Header */
/**
  ******************************************************************************
  * @file           : usbd_cdc_if.c
  * @version        : v2.0_Cube
  * @brief          : Usb device for Virtual Com Port.
  ******************************************************************************
  */
/* USER CODE END Header */

/* Includes ------------------------------------------------------------------*/
#include "usbd_cdc_if.h"

/* USER CODE BEGIN INCLUDE */
#include <string.h>
#include <stdlib.h>
/* USER CODE END INCLUDE */

/* Private typedef -----------------------------------------------------------*/
/* Private define ------------------------------------------------------------*/
/* Private macro -------------------------------------------------------------*/

/* USER CODE BEGIN PV */
/* CDC RX buffer */
static char rx_buffer[10];
static uint8_t rx_index = 0;

/* main.c içinden gelecek */
extern uint8_t servo_angle;
/* USER CODE END PV */

/** @addtogroup STM32_USB_OTG_DEVICE_LIBRARY
  * @{
  */

/** @addtogroup USBD_CDC_IF
  * @{
  */

/* Create buffer for reception and transmission */
uint8_t UserRxBufferFS[APP_RX_DATA_SIZE];
uint8_t UserTxBufferFS[APP_TX_DATA_SIZE];

extern USBD_HandleTypeDef hUsbDeviceFS;

/* Private function prototypes -----------------------------------------------*/
static int8_t CDC_Init_FS(void);
static int8_t CDC_DeInit_FS(void);
static int8_t CDC_Control_FS(uint8_t cmd, uint8_t* pbuf, uint16_t length);
static int8_t CDC_Receive_FS(uint8_t* pbuf, uint32_t *Len);

/* CDC interface */
USBD_CDC_ItfTypeDef USBD_Interface_fops_FS =
{
  CDC_Init_FS,
  CDC_DeInit_FS,
  CDC_Control_FS,
  CDC_Receive_FS
};

/* Private functions ---------------------------------------------------------*/
static int8_t CDC_Init_FS(void)
{
  USBD_CDC_SetTxBuffer(&hUsbDeviceFS, UserTxBufferFS, 0);
  USBD_CDC_SetRxBuffer(&hUsbDeviceFS, UserRxBufferFS);
  return USBD_OK;
}

static int8_t CDC_DeInit_FS(void)
{
  return USBD_OK;
}

static int8_t CDC_Control_FS(uint8_t cmd, uint8_t* pbuf, uint16_t length)
{
  switch(cmd)
  {
    case CDC_SET_LINE_CODING:
    case CDC_GET_LINE_CODING:
    case CDC_SET_CONTROL_LINE_STATE:
    default:
      break;
  }
  return USBD_OK;
}

/* =========================
   USB DATA RECEIVE
   ========================= */
static int8_t CDC_Receive_FS(uint8_t* Buf, uint32_t *Len)
{
  for (uint32_t i = 0; i < *Len; i++)
  {
    char c = Buf[i];

    if (c == '\r' || c == '\n')   // ENTER
    {
      rx_buffer[rx_index] = '\0';
      int angle = atoi(rx_buffer);

      if (angle >= 0 && angle <= 180)
      {
        servo_angle = angle;
      }

      rx_index = 0;  // buffer temizle
    }
    else
    {
      if (rx_index < sizeof(rx_buffer) - 1)
      {
        rx_buffer[rx_index++] = c;
      }
    }
  }

  USBD_CDC_SetRxBuffer(&hUsbDeviceFS, Buf);
  USBD_CDC_ReceivePacket(&hUsbDeviceFS);
  return USBD_OK;
}

/* =========================
   USB TRANSMIT
   ========================= */
uint8_t CDC_Transmit_FS(uint8_t* Buf, uint16_t Len)
{
	  if (hUsbDeviceFS.pClassData == NULL)
	    return USBD_BUSY;

	  USBD_CDC_HandleTypeDef *hcdc =
	      (USBD_CDC_HandleTypeDef*)hUsbDeviceFS.pClassData;

	  if (hcdc->TxState != 0)
	    return USBD_BUSY;

	  USBD_CDC_SetTxBuffer(&hUsbDeviceFS, Buf, Len);
	  return USBD_CDC_TransmitPacket(&hUsbDeviceFS);
}

/* =========================
   STRING GÖNDERME KOLAYLIĞI
   ========================= */
uint8_t CDC_Transmit_String(char* str)
{
  return CDC_Transmit_FS((uint8_t*)str, strlen(str));
}

/**
  * @}
  */
/**
  * @}
  */
